<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FormBuilder Create</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.css">
  <style>
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }
    .formbuilder-text-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-hook-form@7.51.5/dist/index.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.js"></script>
  <script src="https://formbuilder.online/assets/js/form-builder.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const { useEffect, useState, useRef, createElement } = React;
      const { useForm, Controller } = ReactHookForm;

      const FormBuilder = () => {
        const { control, handleSubmit, setValue } = useForm();
        const [authKey, setAuthKey] = useState(localStorage.getItem('authkey') || '');

        useEffect(() => {
          const authKeyRef = authKey;

          const customFields = [
            {
              label: 'Signature',
              attrs: { type: 'signature' },
              icon: '‚úíÔ∏è'
            },
            {
              label: 'Rating',
              attrs: { type: 'rating' },
              icon: 'üåü'
            }
          ];

          const customTemplates = {
            signature: function (fieldData) {
              return {
                field: `<div><input class="form-control" value="${fieldData.value || ''}" id="${fieldData.id}" name="${fieldData.name}" type="hidden" /> <canvas style="padding:5px;outline: black 3px solid;" id="_${fieldData.id}"></canvas></div>`,
                onRender: function () {
                  const signaturePad = new SignaturePad(document.getElementById(`_${fieldData.name}`));
                  if (fieldData.userData) signaturePad.fromData(JSON.parse(fieldData.userData));
                  signaturePad.addEventListener('endStroke', () => {
                    document.getElementById(fieldData.name).setAttribute('value', JSON.stringify(signaturePad.toData()));
                  });
                }
              };
            },
            rating: function (fieldData) {
              return {
                field: `<div><input class="form-control" value="${fieldData.value || ''}" id="${fieldData.id}" name="${fieldData.name}" type="hidden" /> <span id="_${fieldData.id}"></span></div>`,
                onRender: function () {
                  const rate = $(document.getElementById(`_${fieldData.name}`)).rateYo(fieldData.userData ? JSON.parse(fieldData.userData) : {});
                  rate.on('rateyo.set', (e, data) => {
                    document.getElementById(fieldData.name).setAttribute('value', JSON.stringify(data));
                  });
                }
              };
            }
          };

          const options = {
            formData: {},
            fields: customFields,
            templates: customTemplates,
            onSave: function (evt, formData) {
              const title = document.getElementById('user-content-title').value;

              if (!title || !authKeyRef) {
                alert('Missing title/authkey');
                return false;
              }

              $.ajax({
                url: '/form/create',
                type: 'PUT',
                contentType: 'application/json',
                headers: { Authorization: `Bearer ${authKeyRef}` },
                data: JSON.stringify({
                  title: title,
                  data: { form: formData }
                }),
                success: function (result) {
                  fb.actions.clearFields();
                  document.getElementById('user-content-title').value = '';
                  alert(JSON.stringify(result));
                }
              });
            }
          };

          const fb = $('#fb-editor').formBuilder(options);

          (async function () {
            const forms = await $.ajax({
              url: '/form',
              type: 'GET',
              contentType: 'application/json',
              headers: { Authorization: `Bearer ${authKeyRef}` }
            });

            forms.forEach(form => {
              const a = document.createElement('a');
              const li = document.createElement('li');

              a.href = `/formbuilder/${form._id}`;
              a.innerText = `${form.title} | ${form._id}`;
              li.appendChild(a);

              document.getElementById('forms').appendChild(li);
            });
          })();
        }, [authKey]);

        const onSubmit = (data) => {
          setAuthKey(data.authkey);
          localStorage.setItem('authkey', data.authkey);
        };

        return (
          createElement('div', null,
            createElement('form', {
              onSubmit: handleSubmit(onSubmit)
            },
              createElement('div', {
                style: { overflow: 'auto', height: '300px' }
              },
                createElement('label', { htmlFor: 'title', className: 'formbuilder-text-label' }, 'Forms'),
                createElement('ul', { id: 'forms' })
              ),
              createElement('div', null,
                createElement('label', { htmlFor: 'user-content-title', className: 'formbuilder-text-label' }, 'Title'),
                createElement(Controller, {
                  name: 'title',
                  control: control,
                  render: ({ field }) => createElement('input', Object.assign({ type: 'text', id: 'user-content-title' }, field))
                })
              ),
              createElement('div', null,
                createElement('label', { htmlFor: 'authkey', className: 'formbuilder-text-label' }, 'authkey'),
                createElement(Controller, {
                  name: 'authkey',
                  control: control,
                  defaultValue: authKey,
                  render: ({ field }) => createElement('input', Object.assign({ type: 'text', id: 'authkey' }, field)),
                  onChange: (e) => {
                    setValue('authkey', e.target.value);
                    setAuthKey(e.target.value);
                  }
                })
              ),
              createElement('button', { type: 'submit' }, 'Save')
            ),
            createElement('div', { id: 'fb-editor' })
          )
        );
      };

      ReactDOM.render(
        createElement(FormBuilder),
        document.getElementById('root')
      );
    });
  </script>
</body>
</html>
